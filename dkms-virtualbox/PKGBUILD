#Maintainer: John K. Luebs <jkluebs@luebsphoto.com>

pkgname=dkms-virtualbox
pkgver=4.1.8
pkgrel=1
pkgdesc="Kernel modules (DKMS) for VirtualBox"
arch=('i686' 'x86_64')
url='http://virtualbox.org'
license=('GPL')
depends=('dkms')
provides=("virtualbox-modules")
conflicts=("virtualbox-modules")
install=${pkgname}.install
makedepends=('libstdc++5' 'bin86' 'dev86' 'iasl' 'libxslt' 'libxml2' 'libpng' 'libidl2' 'xalan-c' 'sdl' 'linux-headers')
[[ $CARCH == "x86_64" ]] && makedepends=("${makedepends[@]}" 'gcc-multilib' 'lib32-glibc')
options=(!strip)
source=(http://download.virtualbox.org/virtualbox/${pkgver}/VirtualBox-${pkgver}.tar.bz2
         LocalConfig.kmk dkms.conf)
sha1sums=('4683e30aa32d0d6ca764e5ce366d7216705cf0f2'
          '881ee7b1252cd93a4837472fd9088648de3d5840'
          '9a9e9bae9d9ffb97c2790f830b535861cff18036')

build() {
    cd "$srcdir/VirtualBox-${pkgver}_OSE"

    cp "$srcdir/LocalConfig.kmk" .

    ./configure \
        --with-linux=/usr/src/linux-${_kernver} \
        --disable-java \
        --disable-docs \
        --disable-xpcom \
        --disable-python \
        --disable-sdl-ttf \
        --disable-alsa \
        --disable-pulse \
        --disable-dbus  \
        --disable-opengl \
        --build-headless \
        --nofatal
    source ./env.sh
    kmk all
}

package() {
    source "$srcdir/VirtualBox-${pkgver}_OSE/env.sh"
    cd "$srcdir/VirtualBox-${pkgver}_OSE/out/linux.$BUILD_PLATFORM_ARCH/release/bin"

    mkdir -p "${pkgdir}/usr/src"
    cp -a src "${pkgdir}/usr/src/vboxhost-${pkgver}"
    cp ${srcdir}/dkms.conf "${pkgdir}/usr/src/vboxhost-${pkgver}"
}
